---
# Test: x402 Payment Flow End-to-End
# Assumption: User already logged in with active session
# Critical Path: New chat → Ask for Nansen data → Verify response completes

- openLink: http://localhost:19006  # Your local dev server

# Wait for page load
- waitForAnimationToEnd

# Verify we're on chat screen (already logged in)
- assertVisible: 
    text: ".*Chat.*"  # Flexible matching for "New Chat" or chat UI

# Start a conversation requiring x402 payment
- tapOn: 
    text: "New.*Chat"  # Button to start new conversation
    
- inputText: "What tokens are smart money buying on Solana?"

- tapOn:
    text: "Send|Submit"  # Send button

# Wait for AI response to start
- waitForAnimationToEnd:
    timeout: 5000

# CRITICAL: Wait for response to complete (not stop mid-stream)
# This is where the bug occurs - payment fails, stream stops
- waitForAnimationToEnd:
    timeout: 45000  # 45s for API call + payment + Nansen fetch

# Verify response contains actual data (not error)
- assertVisible:
    text: ".*smart money.*"
    
# Verify no error messages
- assertNotVisible:
    text: ".*[Ee]rror.*|.*[Ff]ailed.*"

# Optional: Verify UI shows completed state (not loading/streaming)
- assertNotVisible:
    text: ".*[Ss]treaming.*|.*[Ll]oading.*"

